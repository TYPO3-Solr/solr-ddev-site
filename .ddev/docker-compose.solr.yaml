version: '3'

services:
  solr-site: &typo3-solr-service
    build:
      context:
        ../packages/ext-solr/
      dockerfile: Docker/SolrServer/Dockerfile
      args:
        SOLR_UNIX_UID: ${DDEV_UID}
        SOLR_UNIX_GID: ${DDEV_GID}
    restart: "no"
    ports:
      - 8983
    volumes:
      - solr-site:/var/solr
    labels:
      com.ddev.site-name: ${DDEV_SITENAME}
      com.ddev.approot: $DDEV_APPROOT
    environment:
      - VIRTUAL_HOST=$DDEV_HOSTNAME
      - HTTP_EXPOSE=8983

  solr-tests:
    <<: *typo3-solr-service
    ports:
      - 8985
    volumes:
      - solr-tests:/var/solr
    environment:
      - VIRTUAL_HOST=$DDEV_HOSTNAME
      - SOLR_PORT=8985
      - HTTP_EXPOSE=8985
  web:
    links:
      - solr-tests:$DDEV_HOSTNAME
      - solr-site:$DDEV_HOSTNAME

volumes:
  solr-site: &solr-local-volume
    driver: local
    driver_opts:
      type: none
      device: $DDEV_APPROOT/.ddev/solr/site
      o: bind
  solr-tests:
    <<: *solr-local-volume
    driver_opts:
      device: $DDEV_APPROOT/.ddev/solr/tests
